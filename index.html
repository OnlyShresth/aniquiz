<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Senpai - Ultimate Anime Quiz</title>
    <script src="https://js.puter.com/v2/" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
    
    <style>
        :root {
            --rose: #edafb8;
            --pearl: #f7e1d7;
            --mushroom: #dedbd2;
            --sage: #b0c4b1;
            --slate: #4a5759;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--pearl) 0%, var(--mushroom) 50%, var(--sage) 100%);
            background-size: 400% 400%;
            animation: gradientShift 10s ease-in-out infinite;
            color: var(--slate);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="petals" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="0.8" fill="rgba(237,175,184,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23petals)"/></svg>') repeat;
            animation: float 15s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-50px); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-header {
            text-align: center;
            margin-bottom: 2rem;
            opacity: 0;
        }

        .game-title {
            font-size: 3rem;
            font-weight: bold;
            color: var(--slate);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.1);
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 3s ease-in-out infinite;
        }

        @keyframes titleShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-subtitle {
            font-size: 1.1rem;
            color: var(--slate);
            opacity: 0.8;
        }

        .card-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 100%;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(237,175,184,0.3);
        }

        .card-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(237,175,184,0.1), transparent);
            animation: rotate 8s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-text {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .auth-subtitle {
            font-size: 1rem;
            color: var(--slate);
            line-height: 1.5;
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--slate);
            margin-bottom: 0.5rem;
        }

        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.8rem;
            margin-top: 0.5rem;
        }

        .difficulty-btn {
            padding: 1rem;
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            background: white;
            color: var(--slate);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .difficulty-btn:hover {
            border-color: var(--rose);
            background: var(--pearl);
            transform: translateY(-2px);
        }

        .difficulty-btn.selected {
            border-color: var(--rose);
            background: linear-gradient(135deg, var(--rose), var(--sage));
            color: white;
            transform: scale(1.05);
        }

        .custom-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            font-size: 1rem;
            background: white;
            color: var(--slate);
            transition: all 0.3s ease;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--rose);
            box-shadow: 0 0 0 3px rgba(237,175,184,0.2);
        }

        .game-container {
            max-width: 700px;
            width: 100%;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .score-display, .question-counter {
            background: linear-gradient(135deg, var(--rose), var(--sage));
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .timer-container {
            width: 100%;
            height: 8px;
            background: var(--mushroom);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            border-radius: 10px;
            transition: width 0.1s linear;
            width: 100%;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid var(--rose);
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--slate);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .difficulty-Easy {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .difficulty-Medium {
            background: #FFF3E0;
            color: #F57C00;
        }

        .difficulty-Hard {
            background: #FFEBEE;
            color: #C62828;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .answer-btn {
            background: white;
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            padding: 1rem;
            font-size: 0.95rem;
            color: var(--slate);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            line-height: 1.4;
        }

        .answer-btn:hover {
            border-color: var(--rose);
            background: var(--pearl);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .answer-btn.correct {
            background: #E8F5E8;
            border-color: #4CAF50;
            color: #2E7D32;
        }

        .answer-btn.incorrect {
            background: #FFEBEE;
            border-color: #F44336;
            color: #C62828;
        }

        .answer-btn.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn {
            background: linear-gradient(135deg, var(--rose), var(--sage));
            color: white;
            border: none;
            border-radius: 20px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn.secondary {
            background: var(--mushroom);
            color: var(--slate);
        }

        .error-container {
            background: #FFEBEE;
            border: 2px solid #F44336;
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .error-message {
            color: #C62828;
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--mushroom);
            border-radius: 50%;
            border-top-color: var(--rose);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 2rem;
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1rem;
            color: var(--slate);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in-left {
            animation: slideInLeft 0.4s ease-out forwards;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-in-right {
            animation: slideInRight 0.4s ease-out forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .final-score-display {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 1.5rem 0;
            text-align: center;
        }

        .celebration-text {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            text-align: center;
        }

        .retry-info {
            background: var(--pearl);
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            font-size: 0.9rem;
            color: var(--slate);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .game-title {
                font-size: 2.5rem;
            }
            
            .card-container {
                padding: 1.5rem;
                margin: 10px;
            }
            
            .answers-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .game-info {
                flex-direction: column;
                text-align: center;
                gap: 0.8rem;
            }
            
            .difficulty-selector {
                grid-template-columns: 1fr 1fr;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .answer-btn {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 2rem;
            }
            
            .question-text {
                font-size: 1rem;
            }
            
            .answer-btn {
                padding: 0.7rem;
                font-size: 0.85rem;
            }

            .difficulty-selector {
                grid-template-columns: 1fr;
            }

            .score-display, .question-counter {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Initial state to prevent flash */
        .initial-hide {
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="game-header">
            <h1 class="game-title">Anime Senpai</h1>
            <p class="game-subtitle">Master the Ultimate Anime Knowledge Challenge!</p>
        </header>

        <div id="auth-container" class="card-container initial-hide">
            <div class="auth-text">
                <h2 class="auth-title">Welcome, Future Senpai!</h2>
                <p class="auth-subtitle">Ready to prove your anime expertise? Sign in to begin your journey!</p>
            </div>
            <button id="login-btn" class="btn">Begin Your Quest</button>
            <div id="auth-error" class="error-container" style="display: none;">
                <div class="error-message">Authentication failed. Please try again.</div>
                <button id="retry-auth-btn" class="btn secondary">Retry</button>
            </div>
        </div>

        <div id="setup-container" class="card-container" style="display: none;">
            <div class="auth-text">
                <h2 class="auth-title">Customize Your Challenge</h2>
                <p class="auth-subtitle">Choose your difficulty and focus to create the perfect quiz!</p>
            </div>
            
            <div class="setup-form">
                <div class="form-group">
                    <label class="form-label">Select Your Challenge:</label>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn selected" data-difficulty="mixed">Mixed</button>
                        <button class="difficulty-btn" data-difficulty="easy">Novice</button>
                        <button class="difficulty-btn" data-difficulty="medium">Otaku</button>
                        <button class="difficulty-btn" data-difficulty="hard">Senpai</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="specific-anime">Focus on Specific Anime:</label>
                    <input type="text" id="specific-anime" class="custom-input" 
                           placeholder="e.g., Naruto, Attack on Titan, One Piece...">
                    <small style="color: var(--slate); opacity: 0.7; margin-top: 0.5rem; display: block; font-size: 0.85rem;">
                        Leave empty for questions from various popular anime
                    </small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="anime-genre">Focus on Genre:</label>
                    <input type="text" id="anime-genre" class="custom-input" 
                           placeholder="e.g., Shonen, Romance, Horror, Sci-Fi...">
                    <small style="color: var(--slate); opacity: 0.7; margin-top: 0.5rem; display: block; font-size: 0.85rem;">
                        Leave empty for questions from all genres
                    </small>
                </div>

                <button id="start-quiz-btn" class="btn" style="margin-top: 1rem;">Start Challenge</button>
            </div>
        </div>

        <div id="game-container" class="game-container" style="display: none;">
            <div class="card-container">
                <div class="game-info">
                    <div class="score-display">Score: <span id="score">0</span></div>
                    <div class="question-counter">Question <span id="current-question">1</span> of <span id="total-questions">10</span></div>
                </div>
                
                <div class="timer-container">
                    <div id="timer-bar" class="timer-bar"></div>
                </div>

                <div id="question-container">
                    <!-- Questions will be loaded here -->
                </div>

                <div id="loading-container" class="loading-container" style="display: none;">
                    <div class="loading"></div>
                    <p class="loading-text">Crafting your challenge...</p>
                </div>

                <div id="game-error" class="error-container" style="display: none;">
                    <div class="error-message"></div>
                    <div class="retry-info">
                        Don't worry! Sometimes the question service needs a moment. We'll keep trying to get you great questions!
                    </div>
                    <button id="retry-question-btn" class="btn secondary">Retry Question</button>
                    <button id="end-game-btn" class="btn">End Challenge</button>
                </div>
            </div>
        </div>

        <div id="game-complete-container" class="card-container" style="display: none;">
            <h2 class="celebration-text">Challenge Complete!</h2>
            <div class="final-score-display">
                Score: <span id="final-score">0</span>
            </div>
            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: var(--slate); text-align: center;">
                You conquered <span id="correct-count">0</span> out of <span id="total-count">10</span> questions!
            </p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button id="play-again-btn" class="btn">Challenge Again</button>
                <button id="back-to-setup-btn" class="btn secondary">Change Settings</button>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // Top 30 Popular Anime List for variety
        const POPULAR_ANIME = [
            "Naruto", "One Piece", "Attack on Titan", "Dragon Ball Z", "Demon Slayer", 
            "My Hero Academia", "Death Note", "Fullmetal Alchemist", "One Punch Man", "Tokyo Ghoul",
            "Hunter x Hunter", "Bleach", "Jujutsu Kaisen", "Mob Psycho 100", "Code Geass",
            "Cowboy Bebop", "Evangelion", "JoJo's Bizarre Adventure", "Spy x Family", "Chainsaw Man",
            "Vinland Saga", "Promised Neverland", "Haikyuu", "Fire Force", "Black Clover",
            "Dr. Stone", "Steins;Gate", "Your Name", "Spirited Away", "Princess Mononoke"
        ];

        // Configuration
        const CONFIG = {
            QUESTIONS_PER_SESSION: 10,
            MAX_RETRIES: 2, // Reduced retries for faster loading
            RETRY_DELAY: 500, // Reduced delay for faster loading
            TIMER_DURATIONS: {
                easy: 15,
                medium: 20,
                hard: 30
            },
            POINTS: {
                easy: 10,
                medium: 20,
                hard: 40
            }
        };

        // Game State
        let gameState = {
            score: 0,
            currentQuestionIndex: 0,
            totalQuestions: CONFIG.QUESTIONS_PER_SESSION,
            correctAnswers: 0,
            currentQuestion: null,
            timer: null,
            timeLeft: 0,
            isAnswered: false,
            gameStartTime: null,
            retryCount: 0,
            usedAnime: new Set(),
            settings: {
                difficulty: 'mixed',
                specificAnime: '',
                genre: ''
            }
        };

        // DOM Elements
        const elements = {
            authContainer: document.getElementById('auth-container'),
            setupContainer: document.getElementById('setup-container'),
            gameContainer: document.getElementById('game-container'),
            gameCompleteContainer: document.getElementById('game-complete-container'),
            loginBtn: document.getElementById('login-btn'),
            retryAuthBtn: document.getElementById('retry-auth-btn'),
            authError: document.getElementById('auth-error'),
            difficultyBtns: document.querySelectorAll('.difficulty-btn'),
            specificAnimeInput: document.getElementById('specific-anime'),
            animeGenreInput: document.getElementById('anime-genre'),
            startQuizBtn: document.getElementById('start-quiz-btn'),
            score: document.getElementById('score'),
            currentQuestion: document.getElementById('current-question'),
            totalQuestions: document.getElementById('total-questions'),
            timerBar: document.getElementById('timer-bar'),
            questionContainer: document.getElementById('question-container'),
            loadingContainer: document.getElementById('loading-container'),
            gameError: document.getElementById('game-error'),
            retryQuestionBtn: document.getElementById('retry-question-btn'),
            endGameBtn: document.getElementById('end-game-btn'),
            finalScore: document.getElementById('final-score'),
            correctCount: document.getElementById('correct-count'),
            totalCount: document.getElementById('total-count'),
            playAgainBtn: document.getElementById('play-again-btn'),
            backToSetupBtn: document.getElementById('back-to-setup-btn'),
            gameHeader: document.querySelector('.game-header')
        };

        // Secure string escaping for JavaScript
        function safeJsQuote(str) {
            if (typeof str !== 'string') return '';
            
            // HTML escape first
            const htmlEscaped = str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
            
            // JavaScript escape for single quotes
            return htmlEscaped
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/\n/g, ' ')
                .replace(/\r/g, ' ')
                .replace(/\t/g, ' ');
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing game...');
            
            // Wait for GSAP to load if needed
            if (typeof gsap === 'undefined') {
                console.log('Waiting for GSAP to load...');
                setTimeout(() => initializeGame(), 100);
                return;
            }

            await initializeGame();
        });

        async function initializeGame() {
            console.log('Initializing game...');
            
            // Check if Puter is available
            if (typeof puter === 'undefined') {
                console.error('PuterJS is not available');
                showError('PuterJS is not available. Please check your internet connection.');
                return;
            }

            // Animate header entrance
            gsap.to(elements.gameHeader, {
                opacity: 1,
                y: 0,
                duration: 1,
                ease: "power3.out"
            });

            // Set total questions display
            elements.totalQuestions.textContent = CONFIG.QUESTIONS_PER_SESSION;

            // Setup event listeners
            setupEventListeners();

            // Try auto sign-in first
            try {
                console.log('Attempting auto sign-in...');
                const user = await puter.auth.getUser();
                if (user) {
                    console.log('Auto sign-in successful');
                    setTimeout(() => showSetupScreen(), 10);
                    return;
                }
            } catch (error) {
                console.log('Auto sign-in failed:', error);
            }

            // Show manual login immediately
            console.log('Showing auth container');
            showAuthContainer();
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.retryAuthBtn.addEventListener('click', handleLogin);
            
            // Difficulty selection
            elements.difficultyBtns.forEach(btn => {
                btn.addEventListener('click', () => selectDifficulty(btn));
            });

            elements.startQuizBtn.addEventListener('click', handleQuizStart);
            elements.retryQuestionBtn.addEventListener('click', () => {
                gameState.retryCount = 0; // Reset retry count
                loadNextQuestion();
            });
            elements.endGameBtn.addEventListener('click', endGame);
            elements.playAgainBtn.addEventListener('click', restartGame);
            elements.backToSetupBtn.addEventListener('click', showSetupScreen);

            // Keyboard support
            document.addEventListener('keydown', handleKeyboard);
        }

        function selectDifficulty(selectedBtn) {
            elements.difficultyBtns.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            selectedBtn.classList.add('selected');
            gameState.settings.difficulty = selectedBtn.dataset.difficulty;
            console.log('Selected difficulty:', gameState.settings.difficulty);
        }

        function handleKeyboard(e) {
            if (elements.gameContainer.style.display !== 'none' && !gameState.isAnswered) {
                const answerBtns = document.querySelectorAll('.answer-btn:not(.disabled)');
                if (e.key >= '1' && e.key <= '4') {
                    const index = parseInt(e.key) - 1;
                    if (answerBtns[index]) {
                        answerBtns[index].click();
                    }
                }
            }
        }

        async function handleLogin() {
            console.log('Handling login...');
            try {
                hideError(elements.authError);
                elements.loginBtn.innerHTML = '<div class="loading"></div>';
                
                await puter.auth.signIn();
                console.log('Sign in successful');
                showSetupScreen();
            } catch (error) {
                console.error('Login failed:', error);
                showError('Login failed. Please try again.', elements.authError);
                elements.loginBtn.textContent = 'Begin Your Quest';
            }
        }

        function showSetupScreen() {
            console.log('Showing setup screen...');
            hideAuthContainer();
            
            elements.setupContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.setupContainer, 
                    { opacity: 0, scale: 0.9 }, 
                    { opacity: 1, scale: 1, duration: 0.5, ease: "power3.out" }
                );
            }
        }

        function handleQuizStart() {
            console.log('Handling quiz start...');
            gameState.settings.specificAnime = elements.specificAnimeInput.value.trim();
            gameState.settings.genre = elements.animeGenreInput.value.trim();
            
            console.log('Quiz settings:', gameState.settings);
            startGame();
        }

        function startGame() {
            console.log('Starting game...');
            hideSetupContainer();
            showGameContainer();
            
            resetGameState();
            loadNextQuestion();
        }

        function resetGameState() {
            gameState.score = 0;
            gameState.currentQuestionIndex = 0;
            gameState.correctAnswers = 0;
            gameState.isAnswered = false;
            gameState.gameStartTime = Date.now();
            gameState.retryCount = 0;
            gameState.usedAnime = new Set();
            
            updateUI();
        }

        function updateUI() {
            elements.score.textContent = gameState.score;
            elements.currentQuestion.textContent = gameState.currentQuestionIndex + 1;
        }

        async function loadNextQuestion() {
            console.log('Loading next question...');
            if (gameState.currentQuestionIndex >= CONFIG.QUESTIONS_PER_SESSION) {
                endGame();
                return;
            }

            showLoading();
            hideError(elements.gameError);
            
            try {
                const question = await fetchQuestionWithRetry();
                renderQuestion(question);
                startTimer(question.difficulty);
                gameState.currentQuestionIndex++;
                elements.currentQuestion.textContent = gameState.currentQuestionIndex;
                gameState.retryCount = 0; // Reset retry count on success
            } catch (error) {
                console.error('Failed to load question after retries:', error);
                showError('Having trouble loading questions. This might be a temporary API limit. Please try again in a moment.', elements.gameError);
            }
        }

        async function fetchQuestionWithRetry() {
            for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                try {
                    console.log(`Fetching question, attempt ${attempt}/${CONFIG.MAX_RETRIES}`);
                    const question = await fetchQuestion();
                    return question;
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt === CONFIG.MAX_RETRIES) {
                        throw error;
                    }
                    
                    // Wait before retrying, with exponential backoff
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                }
            }
        }

        async function fetchQuestion() {
            console.log('Fetching question...');
            const systemPrompt = buildSystemPrompt();
            console.log('System prompt:', systemPrompt);

            try {
                const response = await puter.ai.chat(systemPrompt);
                console.log('Raw AI response structure:', response);
                
                // Extract the actual content from the response
                let content;
                if (response && response.message && response.message.content) {
                    content = response.message.content;
                } else if (typeof response === 'string') {
                    content = response;
                } else if (response && response.content) {
                    content = response.content;
                } else {
                    console.error('Unexpected response format:', response);
                    throw new Error('Unexpected response format from AI service');
                }
                
                console.log('Extracted content:', content);
                
                // Parse the JSON content
                let questionData = parseQuestionResponse(content);
                
                console.log('Parsed question data:', questionData);

                // Validate the response
                if (!validateQuestion(questionData)) {
                    console.error('Invalid question format:', questionData);
                    throw new Error('Invalid question format from response');
                }

                gameState.currentQuestion = questionData;
                return questionData;
                
            } catch (error) {
                console.error('Error in fetchQuestion:', error);
                throw error;
            }
        }

        function parseQuestionResponse(content) {
            // Remove common prefixes and suffixes
            let cleanContent = content.trim();
            
            // Remove markdown code blocks
            cleanContent = cleanContent.replace(/``````\n?/g, '');
            
            // Remove any text before the first {
            const jsonStartIndex = cleanContent.indexOf('{');
            if (jsonStartIndex > 0) {
                cleanContent = cleanContent.substring(jsonStartIndex);
            }
            
            // Remove any text after the last }
            const jsonEndIndex = cleanContent.lastIndexOf('}');
            if (jsonEndIndex >= 0 && jsonEndIndex < cleanContent.length - 1) {
                cleanContent = cleanContent.substring(0, jsonEndIndex + 1);
            }
            
            try {
                return JSON.parse(cleanContent);
            } catch (parseError) {
                console.error('JSON parse failed, trying regex extraction...');
                
                // Try to extract JSON using regex
                const jsonMatch = cleanContent.match(/\{[^{}]*\}/);
                if (jsonMatch) {
                    try {
                        return JSON.parse(jsonMatch[0]);
                    } catch (regexParseError) {
                        console.error('Regex extraction also failed:', regexParseError);
                    }
                }
                
                // Last resort: try to parse line by line
                const lines = content.split('\n');
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('{') && trimmedLine.endsWith('}')) {
                        try {
                            return JSON.parse(trimmedLine);
                        } catch (lineParseError) {
                            continue;
                        }
                    }
                }
                
                throw new Error('Could not parse JSON from content: ' + content);
            }
        }

        function getRandomAnime() {
            // Get anime that haven't been used yet
            const availableAnime = POPULAR_ANIME.filter(anime => !gameState.usedAnime.has(anime));
            
            // If we've used all anime, reset the used set
            if (availableAnime.length === 0) {
                gameState.usedAnime.clear();
                return POPULAR_ANIME[Math.floor(Math.random() * POPULAR_ANIME.length)];
            }
            
            const selectedAnime = availableAnime[Math.floor(Math.random() * availableAnime.length)];
            gameState.usedAnime.add(selectedAnime);
            return selectedAnime;
        }

        function buildSystemPrompt() {
            let difficultyInstruction = '';
            let focusInstruction = '';
            let animeSelectionInstruction = '';

            // Handle difficulty
            if (gameState.settings.difficulty === 'mixed') {
                difficultyInstruction = `The difficulty should be randomly selected from "Easy", "Medium", or "Hard".`;
            } else {
                const capitalizedDifficulty = gameState.settings.difficulty.charAt(0).toUpperCase() + gameState.settings.difficulty.slice(1);
                difficultyInstruction = `The difficulty must be exactly "${capitalizedDifficulty}".`;
            }

            // Handle specific anime focus
            if (gameState.settings.specificAnime) {
                focusInstruction = `Create questions ONLY about the anime "${gameState.settings.specificAnime}".`;
                animeSelectionInstruction = `Focus exclusively on "${gameState.settings.specificAnime}".`;
            } else if (gameState.settings.genre) {
                focusInstruction = `Create questions about anime from the ${gameState.settings.genre} genre.`;
                animeSelectionInstruction = `Select from popular ${gameState.settings.genre} anime series.`;
            } else {
                const randomAnime = getRandomAnime();
                focusInstruction = `Create a question about the anime "${randomAnime}".`;
                animeSelectionInstruction = `Focus on "${randomAnime}" for this question.`;
            }

            return `Create a quiz question about anime. You MUST return ONLY a valid JSON object with no additional text, explanations, or formatting whatsoever.

${focusInstruction}
${difficultyInstruction}
${animeSelectionInstruction}

CRITICAL ACCURACY REQUIREMENTS:
1. Before finalizing your question, mentally verify the correct answer is 100% factually accurate
2. Double-check that your correct answer exactly matches one of the four options
3. Ensure all four options are plausible and well-formatted (no spelling errors)
4. Use proper spelling, grammar, and character names throughout
5. Avoid ambiguous questions where multiple answers could be correct
6. For character names, use the most commonly known spellings

Quality guidelines by difficulty:
- Easy: Main protagonist names, basic plot elements, obvious facts (Who is the main character of...)
- Medium: Secondary characters, specific abilities/techniques, story arcs (What is the name of...technique)
- Hard: Minor characters, specific episodes, studio info, voice actors (Which studio animated...)

Examples of GOOD questions:
- Easy: "Who is the main protagonist of Naruto?" 
- Medium: "What is the name of Tanjiro's breathing style in Demon Slayer?"
- Hard: "Which animation studio produced the first season of Attack on Titan?"

Rewrite and elaborate on this requirement, then provide your answer: Create a factually correct anime quiz question with exactly four plausible options where one is definitively correct.

Return exactly this JSON format with no other text:
{
  "question": "Your specific question here",
  "options": ["Option A", "Option B", "Option C", "Option D"],
  "answer": "Exact match to one option",
  "difficulty": "Easy" | "Medium" | "Hard"
}`;
        }

        function validateQuestion(question) {
            if (!question || typeof question !== 'object') {
                console.error('Question is not an object:', question);
                return false;
            }
            
            if (typeof question.question !== 'string' || question.question.length < 5) {
                console.error('Invalid question text:', question.question);
                return false;
            }
            
            if (!Array.isArray(question.options) || question.options.length !== 4) {
                console.error('Invalid options array:', question.options);
                return false;
            }
            
            if (!question.options.every(opt => typeof opt === 'string' && opt.length > 0)) {
                console.error('Invalid option format:', question.options);
                return false;
            }
            
            if (typeof question.answer !== 'string' || !question.options.includes(question.answer)) {
                console.error('Invalid answer:', question.answer, 'Options:', question.options);
                return false;
            }
            
            if (!['Easy', 'Medium', 'Hard'].includes(question.difficulty)) {
                console.error('Invalid difficulty:', question.difficulty);
                return false;
            }
            
            return true;
        }

        function renderQuestion(question) {
            console.log('Rendering question:', question);
            hideLoading();
            gameState.isAnswered = false;
            
            // Use the new safe quoting function
            const safeQuestion = safeJsQuote(question.question);
            const safeOptions = question.options.map(option => safeJsQuote(option));
            
            const questionHTML = `
                <div class="question-card fade-in">
                    <div class="difficulty-badge difficulty-${question.difficulty}">${question.difficulty}</div>
                    <div class="question-text">${question.question}</div>
                    <div class="answers-grid">
                        ${question.options.map((option, index) => `
                            <button class="answer-btn ${index % 2 === 0 ? 'slide-in-left' : 'slide-in-right'}" 
                                    data-answer="${safeOptions[index]}"
                                    onclick="selectAnswerSafe(this)"
                                    style="animation-delay: ${index * 0.1}s">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            elements.questionContainer.innerHTML = questionHTML;
        }

        // New safe answer selection function using data attributes
        function selectAnswerSafe(buttonElement) {
            const selectedAnswer = buttonElement.getAttribute('data-answer');
            selectAnswer(selectedAnswer);
        }

        function startTimer(difficulty) {
            clearInterval(gameState.timer);
            
            // Determine time based on difficulty
            let duration;
            if (gameState.settings.difficulty === 'mixed') {
                duration = CONFIG.TIMER_DURATIONS[difficulty.toLowerCase()];
            } else {
                duration = CONFIG.TIMER_DURATIONS[gameState.settings.difficulty];
            }
            
            gameState.timeLeft = duration;
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimerBar(duration);
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    if (!gameState.isAnswered) {
                        timeUp();
                    }
                }
            }, 1000);
        }

        function updateTimerBar(totalTime) {
            const percentage = (gameState.timeLeft / totalTime) * 100;
            elements.timerBar.style.width = `${percentage}%`;
        }

        function selectAnswer(selectedAnswer) {
            console.log('Answer selected:', selectedAnswer);
            if (gameState.isAnswered) return;
            
            gameState.isAnswered = true;
            clearInterval(gameState.timer);
            
            const answerBtns = document.querySelectorAll('.answer-btn');
            const isCorrect = selectedAnswer === gameState.currentQuestion.answer;
            
            answerBtns.forEach(btn => {
                btn.classList.add('disabled');
                const btnAnswer = btn.getAttribute('data-answer');
                
                if (btnAnswer === gameState.currentQuestion.answer) {
                    btn.classList.add('correct');
                } else if (btnAnswer === selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (isCorrect) {
                gameState.correctAnswers++;
                const difficulty = gameState.currentQuestion.difficulty.toLowerCase();
                gameState.score += CONFIG.POINTS[difficulty];
                updateUI();
            }
            
            setTimeout(() => {
                loadNextQuestion();
            }, 2000);
        }

        function timeUp() {
            console.log('Time up!');
            gameState.isAnswered = true;
            
            const answerBtns = document.querySelectorAll('.answer-btn');
            answerBtns.forEach(btn => {
                btn.classList.add('disabled');
                if (btn.getAttribute('data-answer') === gameState.currentQuestion.answer) {
                    btn.classList.add('correct');
                }
            });
            
            setTimeout(() => {
                loadNextQuestion();
            }, 2000);
        }

        function endGame() {
            console.log('Ending game...');
            clearInterval(gameState.timer);
            
            hideGameContainer();
            showGameCompleteContainer();
            
            elements.finalScore.textContent = gameState.score;
            elements.correctCount.textContent = gameState.correctAnswers;
            elements.totalCount.textContent = CONFIG.QUESTIONS_PER_SESSION;
        }

        function restartGame() {
            console.log('Restarting game...');
            hideGameCompleteContainer();
            resetGameState();
            showGameContainer();
            loadNextQuestion();
        }

        // UI Helper Functions
        function showAuthContainer() {
            elements.authContainer.classList.remove('initial-hide');
            elements.authContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.authContainer, 
                    { opacity: 0, scale: 0.9 }, 
                    { opacity: 1, scale: 1, duration: 0.5 }
                );
            } else {
                elements.authContainer.style.opacity = '1';
            }
        }

        function hideAuthContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.authContainer, {
                    opacity: 0,
                    scale: 0.9,
                    duration: 0.3,
                    onComplete: () => {
                        elements.authContainer.style.display = 'none';
                    }
                });
            } else {
                elements.authContainer.style.display = 'none';
            }
        }

        function hideSetupContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.setupContainer, {
                    opacity: 0,
                    duration: 0.3,
                    onComplete: () => {
                        elements.setupContainer.style.display = 'none';
                    }
                });
            } else {
                elements.setupContainer.style.display = 'none';
            }
        }

        function showGameContainer() {
            elements.gameContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.gameContainer, 
                    { opacity: 0, y: 30 }, 
                    { opacity: 1, y: 0, duration: 0.5 }
                );
            }
        }

        function hideGameContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.gameContainer, {
                    opacity: 0,
                    duration: 0.3,
                    onComplete: () => {
                        elements.gameContainer.style.display = 'none';
                    }
                });
            } else {
                elements.gameContainer.style.display = 'none';
            }
        }

        function showGameCompleteContainer() {
            elements.gameCompleteContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.gameCompleteContainer, 
                    { opacity: 0, scale: 0.9 }, 
                    { opacity: 1, scale: 1, duration: 0.5 }
                );
            }
        }

        function hideGameCompleteContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.gameCompleteContainer, {
                    opacity: 0,
                    duration: 0.3,
                    onComplete: () => {
                        elements.gameCompleteContainer.style.display = 'none';
                    }
                });
            } else {
                elements.gameCompleteContainer.style.display = 'none';
            }
        }

        function showLoading() {
            elements.loadingContainer.style.display = 'block';
            elements.questionContainer.style.display = 'none';
        }

        function hideLoading() {
            elements.loadingContainer.style.display = 'none';
            elements.questionContainer.style.display = 'block';
        }

        function showError(message, container = null) {
            console.log('Showing error:', message);
            if (container) {
                container.style.display = 'block';
                container.querySelector('.error-message').textContent = message;
            }
        }

        function hideError(container) {
            if (container) {
                container.style.display = 'none';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle page cleanup
        window.addEventListener('beforeunload', () => {
            clearInterval(gameState.timer);
            if (typeof gsap !== 'undefined') {
                gsap.killTweensOf("*");
            }
        });
    </script>
</body>
</html>
