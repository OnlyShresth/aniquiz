<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Senpai - Ultimate Anime Quiz</title>
    <script src="https://js.puter.com/v2/" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
    
    <style>
        :root {
            --rose: #edafb8;
            --pearl: #f7e1d7;
            --mushroom: #dedbd2;
            --sage: #b0c4b1;
            --slate: #4a5759;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--pearl) 0%, var(--mushroom) 50%, var(--sage) 100%);
            background-size: 400% 400%;
            animation: gradientShift 10s ease-in-out infinite;
            color: var(--slate);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="petals" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="0.8" fill="rgba(237,175,184,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23petals)"/></svg>') repeat;
            animation: float 15s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-50px); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-header {
            text-align: center;
            margin-bottom: 2rem;
            opacity: 0;
        }

        .game-title {
            font-size: 3rem;
            font-weight: bold;
            color: var(--slate);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.1);
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 3s ease-in-out infinite;
        }

        @keyframes titleShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-subtitle {
            font-size: 1.1rem;
            color: var(--slate);
            opacity: 0.8;
            animation: subtitleFloat 4s ease-in-out infinite;
        }

        @keyframes subtitleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        .card-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 100%;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(237,175,184,0.3);
            margin: 20px auto;
            transform: translateX(0);
            transition: all 0.3s ease;
        }

        .card-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(237,175,184,0.1), transparent);
            animation: rotate 8s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-text {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }

        .auth-subtitle {
            font-size: 1rem;
            color: var(--slate);
            line-height: 1.5;
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .form-group {
            position: relative;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--slate);
            margin-bottom: 0.5rem;
        }

        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.8rem;
            margin-top: 0.5rem;
        }

        .difficulty-btn {
            padding: 1rem;
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            background: white;
            color: var(--slate);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .difficulty-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .difficulty-btn:hover::before {
            left: 100%;
        }

        .difficulty-btn:hover {
            border-color: var(--rose);
            background: var(--pearl);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .difficulty-btn.selected {
            border-color: var(--rose);
            background: linear-gradient(135deg, var(--rose), var(--sage));
            color: white;
            transform: scale(1.05);
            animation: selectedPulse 2s ease-in-out infinite;
        }

        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 5px 15px rgba(237,175,184,0.3); }
            50% { box-shadow: 0 8px 25px rgba(237,175,184,0.5); }
        }

        .custom-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            font-size: 1rem;
            background: white;
            color: var(--slate);
            transition: all 0.3s ease;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--rose);
            box-shadow: 0 0 0 3px rgba(237,175,184,0.2);
            transform: scale(1.02);
        }

        .custom-input:hover {
            border-color: var(--sage);
        }

        .game-container {
            max-width: 700px;
            width: 100%;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .score-display, .question-counter {
            background: linear-gradient(135deg, var(--rose), var(--sage));
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .score-display::after, .question-counter::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: infoShine 3s infinite;
        }

        @keyframes infoShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .timer-container {
            width: 100%;
            height: 8px;
            background: var(--mushroom);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
            animation: timerPulse 0.5s ease-in-out;
        }

        @keyframes timerPulse {
            0% { transform: scaleX(0); }
            100% { transform: scaleX(1); }
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            border-radius: 10px;
            transition: width 0.1s linear;
            width: 100%;
            position: relative;
        }

        .timer-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: timerGlow 2s ease-in-out infinite;
        }

        @keyframes timerGlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid var(--rose);
            position: relative;
            overflow: hidden;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(237,175,184,0.03), transparent);
            animation: questionGlow 4s ease-in-out infinite;
        }

        @keyframes questionGlow {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--slate);
            line-height: 1.5;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
            animation: badgeFloat 3s ease-in-out infinite;
        }

        @keyframes badgeFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        .difficulty-Easy {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .difficulty-Medium {
            background: #FFF3E0;
            color: #F57C00;
        }

        .difficulty-Hard {
            background: #FFEBEE;
            color: #C62828;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .answer-btn {
            background: white;
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            padding: 1rem;
            font-size: 0.95rem;
            color: var(--slate);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: left;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            line-height: 1.4;
        }

        .answer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--pearl), transparent);
            transition: left 0.3s;
        }

        .answer-btn:hover::before {
            left: 100%;
        }

        .answer-btn:hover {
            border-color: var(--rose);
            background: var(--pearl);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .answer-btn:active {
            transform: translateY(-2px) scale(0.98);
        }

        .answer-btn.correct {
            background: #E8F5E8;
            border-color: #4CAF50;
            color: #2E7D32;
            animation: correctAnswer 0.8s ease-in-out;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1.05); }
        }

        .answer-btn.incorrect {
            background: #FFEBEE;
            border-color: #F44336;
            color: #C62828;
            animation: incorrectShake 0.6s ease-in-out;
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .answer-btn.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn {
            background: linear-gradient(135deg, var(--rose), var(--sage));
            color: white;
            border: none;
            border-radius: 20px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn.secondary {
            background: var(--mushroom);
            color: var(--slate);
        }

        .error-container {
            background: #FFEBEE;
            border: 2px solid #F44336;
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            animation: errorPulse 2s ease-in-out infinite alternate;
        }

        @keyframes errorPulse {
            0% { box-shadow: 0 0 0 0 rgba(244,67,54,0.4); }
            100% { box-shadow: 0 0 0 10px rgba(244,67,54,0); }
        }

        .error-message {
            color: #C62828;
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--mushroom);
            border-radius: 50%;
            border-top-color: var(--rose);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 2rem;
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1rem;
            color: var(--slate);
            animation: loadingPulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes loadingPulse {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .slide-in-left {
            animation: slideInLeft 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px) rotate(-5deg); }
            to { opacity: 1; transform: translateX(0) rotate(0deg); }
        }

        .slide-in-right {
            animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px) rotate(5deg); }
            to { opacity: 1; transform: translateX(0) rotate(0deg); }
        }

        .final-score-display {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 1.5rem 0;
            text-align: center;
            animation: scoreGlow 2s ease-in-out infinite alternate;
        }

        @keyframes scoreGlow {
            0% { filter: brightness(1); transform: scale(1); }
            100% { filter: brightness(1.2); transform: scale(1.05); }
        }

        .celebration-text {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--rose), var(--sage));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
        }

        .celebration-text::before {
            content: 'ðŸŽ‰';
            position: absolute;
            left: -50px;
            animation: celebrate 2s ease-in-out infinite;
        }

        .celebration-text::after {
            content: 'ðŸŽŠ';
            position: absolute;
            right: -50px;
            animation: celebrate 2s ease-in-out infinite reverse;
        }

        @keyframes celebrate {
            0%, 100% { transform: rotate(-15deg) scale(1); }
            50% { transform: rotate(15deg) scale(1.2); }
        }

        .retry-info {
            background: var(--pearl);
            border: 2px solid var(--mushroom);
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            font-size: 0.9rem;
            color: var(--slate);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .game-title {
                font-size: 2.5rem;
            }
            
            .card-container {
                padding: 1.5rem;
                margin: 10px;
                max-width: 95%;
            }
            
            .answers-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .game-info {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .difficulty-selector {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .answer-btn {
                padding: 1rem;
                font-size: 1rem;
            }

            .btn {
                padding: 1rem 1.5rem;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 2rem;
            }
            
            .question-text {
                font-size: 1rem;
            }
            
            .answer-btn {
                padding: 0.8rem;
                font-size: 0.9rem;
            }

            .difficulty-selector {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .score-display, .question-counter {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .card-container {
                padding: 1rem;
                margin: 5px;
            }

            .celebration-text::before,
            .celebration-text::after {
                display: none;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .answer-btn {
                padding: 1.2rem;
                font-size: 1rem;
            }
            
            .btn {
                padding: 1.2rem 2rem;
                font-size: 1.1rem;
            }
            
            .difficulty-btn {
                padding: 1.2rem;
            }
        }

        /* Initial state to prevent flash */
        .initial-hide {
            opacity: 0;
            visibility: hidden;
        }

        /* Preloader for next question */
        .preloader {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--pearl);
            border-top: 2px solid var(--rose);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0.7;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="game-header">
            <h1 class="game-title">Anime Senpai</h1>
            <p class="game-subtitle">Master the Ultimate Anime Knowledge Challenge!</p>
        </header>

        <div id="auth-container" class="card-container initial-hide">
            <div class="auth-text">
                <h2 class="auth-title">Welcome, Future Senpai!</h2>
                <p class="auth-subtitle">Ready to prove your anime expertise? Sign in to begin your journey!</p>
            </div>
            <button id="login-btn" class="btn">Begin Your Quest</button>
            <div id="auth-error" class="error-container" style="display: none;">
                <div class="error-message">Authentication failed. Please try again.</div>
                <button id="retry-auth-btn" class="btn secondary">Retry</button>
            </div>
        </div>

        <div id="setup-container" class="card-container" style="display: none;">
            <div class="auth-text">
                <h2 class="auth-title">Customize Your Challenge</h2>
                <p class="auth-subtitle">Choose your difficulty and focus to create the perfect quiz!</p>
            </div>
            
            <div class="setup-form">
                <div class="form-group">
                    <label class="form-label">Select Your Challenge:</label>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn selected" data-difficulty="mixed">Mixed</button>
                        <button class="difficulty-btn" data-difficulty="easy">Novice</button>
                        <button class="difficulty-btn" data-difficulty="medium">Otaku</button>
                        <button class="difficulty-btn" data-difficulty="hard">Senpai</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="specific-anime">Focus on Specific Anime:</label>
                    <input type="text" id="specific-anime" class="custom-input" 
                           placeholder="e.g., Naruto, Attack on Titan, One Piece...">
                    <small style="color: var(--slate); opacity: 0.7; margin-top: 0.5rem; display: block; font-size: 0.85rem;">
                        Leave empty for questions from various popular anime
                    </small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="anime-genre">Focus on Genre:</label>
                    <input type="text" id="anime-genre" class="custom-input" 
                           placeholder="e.g., Shonen, Romance, Horror, Sci-Fi...">
                    <small style="color: var(--slate); opacity: 0.7; margin-top: 0.5rem; display: block; font-size: 0.85rem;">
                        Leave empty for questions from all genres
                    </small>
                </div>

                <button id="start-quiz-btn" class="btn" style="margin-top: 1rem;">Start Challenge</button>
            </div>
        </div>

        <div id="game-container" class="game-container" style="display: none;">
            <div class="card-container">
                <div class="game-info">
                    <div class="score-display">Score: <span id="score">0</span></div>
                    <div class="question-counter">Question <span id="current-question">1</span> of <span id="total-questions">10</span></div>
                </div>
                
                <div class="timer-container">
                    <div id="timer-bar" class="timer-bar"></div>
                </div>

                <div id="question-container">
                    <!-- Questions will be loaded here -->
                </div>

                <div id="loading-container" class="loading-container" style="display: none;">
                    <div class="loading"></div>
                    <p class="loading-text">Crafting your challenge...</p>
                </div>

                <div id="game-error" class="error-container" style="display: none;">
                    <div class="error-message"></div>
                    <div class="retry-info">
                        Don't worry! Sometimes the question service needs a moment. We'll keep trying to get you great questions!
                    </div>
                    <button id="retry-question-btn" class="btn secondary">Retry Question</button>
                    <button id="end-game-btn" class="btn">End Challenge</button>
                </div>
            </div>
        </div>

        <div id="game-complete-container" class="card-container" style="display: none;">
            <h2 class="celebration-text">Challenge Complete!</h2>
            <div class="final-score-display">
                Score: <span id="final-score">0</span>
            </div>
            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: var(--slate); text-align: center;">
                You conquered <span id="correct-count">0</span> out of <span id="total-count">10</span> questions!
            </p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button id="play-again-btn" class="btn">Challenge Again</button>
                <button id="back-to-setup-btn" class="btn secondary">Change Settings</button>
            </div>
        </div>
    </div>

    <div id="preloader" class="preloader" style="display: none;"></div>

    <script>
        'use strict';

        // Top 30 Popular Anime List for variety
        const POPULAR_ANIME = [
            "Naruto", "One Piece", "Attack on Titan", "Dragon Ball Z", "Demon Slayer", 
            "My Hero Academia", "Death Note", "Fullmetal Alchemist", "One Punch Man", "Tokyo Ghoul",
            "Hunter x Hunter", "Bleach", "Jujutsu Kaisen", "Mob Psycho 100", "Code Geass",
            "Cowboy Bebop", "Evangelion", "JoJo's Bizarre Adventure", "Spy x Family", "Chainsaw Man",
            "Vinland Saga", "Promised Neverland", "Haikyuu", "Fire Force", "Black Clover",
            "Dr. Stone", "Steins;Gate", "Your Name", "Spirited Away", "Princess Mononoke"
        ];

        // Enhanced question templates for variety
        const QUESTION_TEMPLATES = {
            easy: [
                "Who is the main protagonist of {anime}?",
                "What is the primary genre of {anime}?",
                "In {anime}, what is the main character's goal?",
                "What color is {character}'s hair in {anime}?",
                "What type of power does the main character have in {anime}?"
            ],
            medium: [
                "What is the name of {character}'s special technique in {anime}?",
                "Which organization does {character} belong to in {anime}?",
                "What is the name of {character}'s weapon in {anime}?",
                "In {anime}, what is the name of the main villain?",
                "What is {character}'s rank or title in {anime}?"
            ],
            hard: [
                "Which animation studio produced {anime}?",
                "Who is the voice actor for {character} in {anime}?",
                "In which year was {anime} first released?",
                "What is the name of episode {number} in {anime}?",
                "Who is the manga creator of {anime}?"
            ]
        };

        // Configuration
        const CONFIG = {
            QUESTIONS_PER_SESSION: 10,
            MAX_RETRIES: 2,
            RETRY_DELAY: 500,
            TIMER_DURATIONS: {
                easy: 15,
                medium: 20,
                hard: 30
            },
            POINTS: {
                easy: 10,
                medium: 20,
                hard: 40
            }
        };

        // Game State
        let gameState = {
            score: 0,
            currentQuestionIndex: 0,
            totalQuestions: CONFIG.QUESTIONS_PER_SESSION,
            correctAnswers: 0,
            currentQuestion: null,
            nextQuestion: null, // Preloaded question
            timer: null,
            timeLeft: 0,
            isAnswered: false,
            gameStartTime: null,
            retryCount: 0,
            usedAnime: new Set(),
            settings: {
                difficulty: 'mixed',
                specificAnime: '',
                genre: ''
            }
        };

        // DOM Elements
        const elements = {
            authContainer: document.getElementById('auth-container'),
            setupContainer: document.getElementById('setup-container'),
            gameContainer: document.getElementById('game-container'),
            gameCompleteContainer: document.getElementById('game-complete-container'),
            loginBtn: document.getElementById('login-btn'),
            retryAuthBtn: document.getElementById('retry-auth-btn'),
            authError: document.getElementById('auth-error'),
            difficultyBtns: document.querySelectorAll('.difficulty-btn'),
            specificAnimeInput: document.getElementById('specific-anime'),
            animeGenreInput: document.getElementById('anime-genre'),
            startQuizBtn: document.getElementById('start-quiz-btn'),
            score: document.getElementById('score'),
            currentQuestion: document.getElementById('current-question'),
            totalQuestions: document.getElementById('total-questions'),
            timerBar: document.getElementById('timer-bar'),
            questionContainer: document.getElementById('question-container'),
            loadingContainer: document.getElementById('loading-container'),
            gameError: document.getElementById('game-error'),
            retryQuestionBtn: document.getElementById('retry-question-btn'),
            endGameBtn: document.getElementById('end-game-btn'),
            finalScore: document.getElementById('final-score'),
            correctCount: document.getElementById('correct-count'),
            totalCount: document.getElementById('total-count'),
            playAgainBtn: document.getElementById('play-again-btn'),
            backToSetupBtn: document.getElementById('back-to-setup-btn'),
            gameHeader: document.querySelector('.game-header'),
            preloader: document.getElementById('preloader')
        };

        // Secure string escaping for JavaScript
        function safeJsQuote(str) {
            if (typeof str !== 'string') return '';
            
            // HTML escape first
            const htmlEscaped = str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
            
            // JavaScript escape for single quotes
            return htmlEscaped
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/\n/g, ' ')
                .replace(/\r/g, ' ')
                .replace(/\t/g, ' ');
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing game...');
            
            // Wait for GSAP to load if needed
            if (typeof gsap === 'undefined') {
                console.log('Waiting for GSAP to load...');
                setTimeout(() => initializeGame(), 100);
                return;
            }

            await initializeGame();
        });

        async function initializeGame() {
            console.log('Initializing game...');
            
            // Check if Puter is available
            if (typeof puter === 'undefined') {
                console.error('PuterJS is not available');
                showError('PuterJS is not available. Please check your internet connection.');
                return;
            }

            // Animate header entrance
            gsap.to(elements.gameHeader, {
                opacity: 1,
                y: 0,
                duration: 1.5,
                ease: "power3.out"
            });

            // Set total questions display
            elements.totalQuestions.textContent = CONFIG.QUESTIONS_PER_SESSION;

            // Setup event listeners
            setupEventListeners();

            // Try auto sign-in first
            try {
                console.log('Attempting auto sign-in...');
                const user = await puter.auth.getUser();
                if (user) {
                    console.log('Auto sign-in successful');
                    setTimeout(() => showSetupScreen(), 10);
                    return;
                }
            } catch (error) {
                console.log('Auto sign-in failed:', error);
            }

            // Show manual login immediately
            console.log('Showing auth container');
            showAuthContainer();
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.retryAuthBtn.addEventListener('click', handleLogin);
            
            // Difficulty selection with animation
            elements.difficultyBtns.forEach((btn, index) => {
                btn.addEventListener('click', () => selectDifficulty(btn));
                // Stagger animation
                gsap.set(btn, { opacity: 0, y: 20 });
                gsap.to(btn, { 
                    opacity: 1, 
                    y: 0, 
                    duration: 0.5, 
                    delay: index * 0.1,
                    ease: "back.out(1.7)"
                });
            });

            elements.startQuizBtn.addEventListener('click', handleQuizStart);
            elements.retryQuestionBtn.addEventListener('click', () => {
                gameState.retryCount = 0;
                loadNextQuestion();
            });
            elements.endGameBtn.addEventListener('click', endGame);
            elements.playAgainBtn.addEventListener('click', restartGame);
            elements.backToSetupBtn.addEventListener('click', showSetupScreen);

            // Keyboard support
            document.addEventListener('keydown', handleKeyboard);
        }

        function selectDifficulty(selectedBtn) {
            elements.difficultyBtns.forEach(btn => {
                btn.classList.remove('selected');
                gsap.to(btn, { scale: 1, duration: 0.3 });
            });
            
            selectedBtn.classList.add('selected');
            gameState.settings.difficulty = selectedBtn.dataset.difficulty;
            
            // Animate selection
            gsap.to(selectedBtn, { 
                scale: 1.05, 
                duration: 0.3,
                ease: "back.out(1.7)"
            });
            
            console.log('Selected difficulty:', gameState.settings.difficulty);
        }

        function handleKeyboard(e) {
            if (elements.gameContainer.style.display !== 'none' && !gameState.isAnswered) {
                const answerBtns = document.querySelectorAll('.answer-btn:not(.disabled)');
                if (e.key >= '1' && e.key <= '4') {
                    const index = parseInt(e.key) - 1;
                    if (answerBtns[index]) {
                        answerBtns[index].click();
                    }
                }
            }
        }

        async function handleLogin() {
            console.log('Handling login...');
            try {
                hideError(elements.authError);
                elements.loginBtn.innerHTML = '<div class="loading"></div>';
                
                await puter.auth.signIn();
                console.log('Sign in successful');
                showSetupScreen();
            } catch (error) {
                console.error('Login failed:', error);
                showError('Login failed. Please try again.', elements.authError);
                elements.loginBtn.textContent = 'Begin Your Quest';
            }
        }

        function showSetupScreen() {
            console.log('Showing setup screen...');
            hideAuthContainer();
            
            elements.setupContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.setupContainer, 
                    { opacity: 0, scale: 0.8, rotationY: -90 }, 
                    { opacity: 1, scale: 1, rotationY: 0, duration: 0.8, ease: "power3.out" }
                );
            }
        }

        function handleQuizStart() {
            console.log('Handling quiz start...');
            gameState.settings.specificAnime = elements.specificAnimeInput.value.trim();
            gameState.settings.genre = elements.animeGenreInput.value.trim();
            
            console.log('Quiz settings:', gameState.settings);
            
            // Animate button press
            gsap.to(elements.startQuizBtn, {
                scale: 0.95,
                duration: 0.1,
                yoyo: true,
                repeat: 1,
                onComplete: startGame
            });
        }

        function startGame() {
            console.log('Starting game...');
            hideSetupContainer();
            showGameContainer();
            
            resetGameState();
            loadNextQuestion();
        }

        function resetGameState() {
            gameState.score = 0;
            gameState.currentQuestionIndex = 0;
            gameState.correctAnswers = 0;
            gameState.isAnswered = false;
            gameState.gameStartTime = Date.now();
            gameState.retryCount = 0;
            gameState.usedAnime = new Set();
            gameState.nextQuestion = null;
            
            updateUI();
        }

        function updateUI() {
            elements.score.textContent = gameState.score;
            elements.currentQuestion.textContent = gameState.currentQuestionIndex + 1;
            
            // Animate score update with bounce
            gsap.fromTo(elements.score.parentElement, 
                { scale: 1 }, 
                { 
                    scale: 1.1, 
                    duration: 0.2, 
                    ease: "back.out(2)",
                    yoyo: true, 
                    repeat: 1 
                }
            );
        }

        async function loadNextQuestion() {
            console.log('Loading next question...');
            if (gameState.currentQuestionIndex >= CONFIG.QUESTIONS_PER_SESSION) {
                endGame();
                return;
            }

            showLoading();
            hideError(elements.gameError);
            
            try {
                let question;
                
                // Use preloaded question if available
                if (gameState.nextQuestion) {
                    question = gameState.nextQuestion;
                    gameState.nextQuestion = null;
                } else {
                    question = await fetchQuestionWithRetry();
                }
                
                renderQuestion(question);
                startTimer(question.difficulty);
                gameState.currentQuestionIndex++;
                elements.currentQuestion.textContent = gameState.currentQuestionIndex;
                gameState.retryCount = 0;
                
                // Preload next question if not the last one
                if (gameState.currentQuestionIndex < CONFIG.QUESTIONS_PER_SESSION) {
                    preloadNextQuestion();
                }
                
            } catch (error) {
                console.error('Failed to load question after retries:', error);
                showError('Having trouble loading questions. This might be a temporary API limit. Please try again in a moment.', elements.gameError);
            }
        }

        async function preloadNextQuestion() {
            elements.preloader.style.display = 'block';
            try {
                gameState.nextQuestion = await fetchQuestionWithRetry();
                console.log('Next question preloaded');
            } catch (error) {
                console.log('Failed to preload next question:', error);
            } finally {
                elements.preloader.style.display = 'none';
            }
        }

        async function fetchQuestionWithRetry() {
            for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                try {
                    console.log(`Fetching question, attempt ${attempt}/${CONFIG.MAX_RETRIES}`);
                    const question = await fetchQuestion();
                    return question;
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt === CONFIG.MAX_RETRIES) {
                        throw error;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                }
            }
        }

        async function fetchQuestion() {
            console.log('Fetching question...');
            const systemPrompt = buildSystemPrompt();
            console.log('System prompt:', systemPrompt);

            try {
                const response = await puter.ai.chat(systemPrompt);
                console.log('Raw AI response structure:', response);
                
                let content;
                if (response && response.message && response.message.content) {
                    content = response.message.content;
                } else if (typeof response === 'string') {
                    content = response;
                } else if (response && response.content) {
                    content = response.content;
                } else {
                    console.error('Unexpected response format:', response);
                    throw new Error('Unexpected response format from AI service');
                }
                
                console.log('Extracted content:', content);
                
                let questionData = parseQuestionResponse(content);
                console.log('Parsed question data:', questionData);

                if (!validateQuestion(questionData)) {
                    console.error('Invalid question format:', questionData);
                    throw new Error('Invalid question format from response');
                }

                gameState.currentQuestion = questionData;
                return questionData;
                
            } catch (error) {
                console.error('Error in fetchQuestion:', error);
                throw error;
            }
        }

        function parseQuestionResponse(content) {
            let cleanContent = content.trim();
            
            // Remove markdown code blocks
            cleanContent = cleanContent.replace(/``````\n?/g, '');
            
            const jsonStartIndex = cleanContent.indexOf('{');
            if (jsonStartIndex > 0) {
                cleanContent = cleanContent.substring(jsonStartIndex);
            }
            
            const jsonEndIndex = cleanContent.lastIndexOf('}');
            if (jsonEndIndex >= 0 && jsonEndIndex < cleanContent.length - 1) {
                cleanContent = cleanContent.substring(0, jsonEndIndex + 1);
            }
            
            try {
                return JSON.parse(cleanContent);
            } catch (parseError) {
                console.error('JSON parse failed, trying regex extraction...');
                
                const jsonMatch = cleanContent.match(/\{[^{}]*\}/);
                if (jsonMatch) {
                    try {
                        return JSON.parse(jsonMatch[0]);
                    } catch (regexParseError) {
                        console.error('Regex extraction also failed:', regexParseError);
                    }
                }
                
                const lines = content.split('\n');
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('{') && trimmedLine.endsWith('}')) {
                        try {
                            return JSON.parse(trimmedLine);
                        } catch (lineParseError) {
                            continue;
                        }
                    }
                }
                
                throw new Error('Could not parse JSON from content: ' + content);
            }
        }

        function getRandomAnime() {
            const availableAnime = POPULAR_ANIME.filter(anime => !gameState.usedAnime.has(anime));
            
            if (availableAnime.length === 0) {
                gameState.usedAnime.clear();
                return POPULAR_ANIME[Math.floor(Math.random() * POPULAR_ANIME.length)];
            }
            
            const selectedAnime = availableAnime[Math.floor(Math.random() * availableAnime.length)];
            gameState.usedAnime.add(selectedAnime);
            return selectedAnime;
        }

        function getDifficultyForMixed() {
            const difficulties = ['Easy', 'Medium', 'Hard'];
            return difficulties[Math.floor(Math.random() * difficulties.length)];
        }

        function buildSystemPrompt() {
            let difficultyInstruction = '';
            let focusInstruction = '';
            let animeSelectionInstruction = '';
            let targetDifficulty;

            // Handle difficulty - Fixed mixed mode
            if (gameState.settings.difficulty === 'mixed') {
                targetDifficulty = getDifficultyForMixed();
                difficultyInstruction = `The difficulty must be exactly "${targetDifficulty}".`;
            } else {
                targetDifficulty = gameState.settings.difficulty.charAt(0).toUpperCase() + gameState.settings.difficulty.slice(1);
                difficultyInstruction = `The difficulty must be exactly "${targetDifficulty}".`;
            }

            // Handle specific anime focus
            if (gameState.settings.specificAnime) {
                focusInstruction = `Create questions ONLY about the anime "${gameState.settings.specificAnime}".`;
                animeSelectionInstruction = `Focus exclusively on "${gameState.settings.specificAnime}".`;
            } else if (gameState.settings.genre) {
                focusInstruction = `Create questions about anime from the ${gameState.settings.genre} genre.`;
                animeSelectionInstruction = `Select from popular ${gameState.settings.genre} anime series.`;
            } else {
                const randomAnime = getRandomAnime();
                focusInstruction = `Create a question about the anime "${randomAnime}".`;
                animeSelectionInstruction = `Focus on "${randomAnime}" for this question.`;
            }

            // Enhanced variety prompts
            const varietyPrompts = {
                Easy: [
                    "Ask about main characters, their names, appearances, or basic traits",
                    "Ask about the anime's setting, world, or basic plot elements", 
                    "Ask about character relationships or basic story facts",
                    "Ask about obvious visual elements or anime genres"
                ],
                Medium: [
                    "Ask about special abilities, techniques, or powers",
                    "Ask about supporting characters or secondary protagonists",
                    "Ask about specific story arcs, episodes, or battles",
                    "Ask about character backstories or motivations"
                ],
                Hard: [
                    "Ask about production details, studios, or release years",
                    "Ask about voice actors, creators, or staff",
                    "Ask about specific episode numbers, titles, or minor details",
                    "Ask about manga origins, spin-offs, or franchise details"
                ]
            };

            const varietyPrompt = varietyPrompts[targetDifficulty][Math.floor(Math.random() * varietyPrompts[targetDifficulty].length)];

            return `Create a quiz question about anime. You MUST return ONLY a valid JSON object with no additional text, explanations, or formatting whatsoever.

${focusInstruction}
${difficultyInstruction}
${animeSelectionInstruction}

VARIETY REQUIREMENT: ${varietyPrompt}

CRITICAL ACCURACY REQUIREMENTS:
1. Before finalizing your question, mentally verify the correct answer is 100% factually accurate
2. Double-check that your correct answer exactly matches one of the four options
3. Ensure all four options are plausible and well-formatted (no spelling errors)
4. Use proper spelling, grammar, and character names throughout
5. Avoid repetitive question patterns - vary your question types
6. For character names, use the most commonly known spellings

Quality guidelines by difficulty:
- Easy: Main protagonist names, basic plot elements, obvious facts, character appearances
- Medium: Secondary characters, specific abilities/techniques, story arcs, character relationships
- Hard: Minor characters, specific episodes, studio info, voice actors, production details

Examples of GOOD varied questions:
- Easy: "What color is Naruto's signature outfit?", "Where does the story of Attack on Titan take place?"
- Medium: "What is the name of Ichigo's zanpakuto in Bleach?", "Which Hashira does Tanjiro first encounter?"
- Hard: "Which studio animated Cowboy Bebop?", "Who composed the music for Spirited Away?"

Return exactly this JSON format with no other text:
{
  "question": "Your specific question here",
  "options": ["Option A", "Option B", "Option C", "Option D"],
  "answer": "Exact match to one option",
  "difficulty": "${targetDifficulty}"
}`;
        }

        function validateQuestion(question) {
            if (!question || typeof question !== 'object') {
                console.error('Question is not an object:', question);
                return false;
            }
            
            if (typeof question.question !== 'string' || question.question.length < 5) {
                console.error('Invalid question text:', question.question);
                return false;
            }
            
            if (!Array.isArray(question.options) || question.options.length !== 4) {
                console.error('Invalid options array:', question.options);
                return false;
            }
            
            if (!question.options.every(opt => typeof opt === 'string' && opt.length > 0)) {
                console.error('Invalid option format:', question.options);
                return false;
            }
            
            if (typeof question.answer !== 'string' || !question.options.includes(question.answer)) {
                console.error('Invalid answer:', question.answer, 'Options:', question.options);
                return false;
            }
            
            if (!['Easy', 'Medium', 'Hard'].includes(question.difficulty)) {
                console.error('Invalid difficulty:', question.difficulty);
                return false;
            }
            
            return true;
        }

        function renderQuestion(question) {
            console.log('Rendering question:', question);
            hideLoading();
            gameState.isAnswered = false;
            
            const safeQuestion = safeJsQuote(question.question);
            const safeOptions = question.options.map(option => safeJsQuote(option));
            
            const questionHTML = `
                <div class="question-card fade-in">
                    <div class="difficulty-badge difficulty-${question.difficulty}">${question.difficulty}</div>
                    <div class="question-text">${question.question}</div>
                    <div class="answers-grid">
                        ${question.options.map((option, index) => `
                            <button class="answer-btn ${index % 2 === 0 ? 'slide-in-left' : 'slide-in-right'}" 
                                    data-answer="${safeOptions[index]}"
                                    onclick="selectAnswerSafe(this)"
                                    style="animation-delay: ${index * 0.15}s">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            elements.questionContainer.innerHTML = questionHTML;
        }

        function selectAnswerSafe(buttonElement) {
            const selectedAnswer = buttonElement.getAttribute('data-answer');
            selectAnswer(selectedAnswer);
        }

        function startTimer(difficulty) {
            clearInterval(gameState.timer);
            
            let duration;
            if (gameState.settings.difficulty === 'mixed') {
                duration = CONFIG.TIMER_DURATIONS[difficulty.toLowerCase()];
            } else {
                duration = CONFIG.TIMER_DURATIONS[gameState.settings.difficulty];
            }
            
            gameState.timeLeft = duration;
            
            // Animate timer start
            gsap.fromTo(elements.timerBar, 
                { width: '0%' },
                { width: '100%', duration: 0.3, ease: "power2.out" }
            );
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimerBar(duration);
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    if (!gameState.isAnswered) {
                        timeUp();
                    }
                }
            }, 1000);
        }

        function updateTimerBar(totalTime) {
            const percentage = (gameState.timeLeft / totalTime) * 100;
            elements.timerBar.style.width = `${percentage}%`;
            
            // Add urgency animation when time is low
            if (percentage < 30 && percentage > 0) {
                gsap.to('.timer-container', {
                    scale: 1.02,
                    duration: 0.2,
                    yoyo: true,
                    repeat: -1,
                    ease: "power2.inOut"
                });
            }
        }

        function selectAnswer(selectedAnswer) {
            console.log('Answer selected:', selectedAnswer);
            if (gameState.isAnswered) return;
            
            gameState.isAnswered = true;
            clearInterval(gameState.timer);
            
            // Stop urgency animation
            gsap.killTweensOf('.timer-container');
            gsap.set('.timer-container', { scale: 1 });
            
            const answerBtns = document.querySelectorAll('.answer-btn');
            const isCorrect = selectedAnswer === gameState.currentQuestion.answer;
            
            answerBtns.forEach(btn => {
                btn.classList.add('disabled');
                const btnAnswer = btn.getAttribute('data-answer');
                
                if (btnAnswer === gameState.currentQuestion.answer) {
                    btn.classList.add('correct');
                } else if (btnAnswer === selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                } else {
                    // Fade out other options
                    gsap.to(btn, { opacity: 0.4, duration: 0.3 });
                }
            });
            
            if (isCorrect) {
                gameState.correctAnswers++;
                const difficulty = gameState.currentQuestion.difficulty.toLowerCase();
                gameState.score += CONFIG.POINTS[difficulty];
                updateUI();
                
                // Create success particles
                createSuccessParticles();
            }
            
            setTimeout(() => {
                loadNextQuestion();
            }, 2000);
        }

        function createSuccessParticles() {
            const emojis = ['ðŸŽ‰', 'â­', 'âœ¨', 'ðŸŒŸ', 'ðŸ’«'];
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
                particle.style.position = 'fixed';
                particle.style.fontSize = '1.5rem';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '9999';
                particle.style.left = Math.random() * window.innerWidth + 'px';
                particle.style.top = window.innerHeight + 'px';
                
                document.body.appendChild(particle);
                
                gsap.to(particle, {
                    y: -window.innerHeight - 50,
                    x: (Math.random() - 0.5) * 200,
                    rotation: Math.random() * 360,
                    scale: Math.random() * 0.5 + 0.5,
                    duration: 2.5,
                    ease: "power2.out",
                    onComplete: () => particle.remove()
                });
            }
        }

        function timeUp() {
            console.log('Time up!');
            gameState.isAnswered = true;
            
            const answerBtns = document.querySelectorAll('.answer-btn');
            answerBtns.forEach(btn => {
                btn.classList.add('disabled');
                if (btn.getAttribute('data-answer') === gameState.currentQuestion.answer) {
                    btn.classList.add('correct');
                } else {
                    gsap.to(btn, { opacity: 0.4, duration: 0.3 });
                }
            });
            
            setTimeout(() => {
                loadNextQuestion();
            }, 2000);
        }

        function endGame() {
            console.log('Ending game...');
            clearInterval(gameState.timer);
            gsap.killTweensOf('.timer-container');
            elements.preloader.style.display = 'none';
            
            hideGameContainer();
            showGameCompleteContainer();
            
            elements.finalScore.textContent = gameState.score;
            elements.correctCount.textContent = gameState.correctAnswers;
            elements.totalCount.textContent = CONFIG.QUESTIONS_PER_SESSION;
        }

        function restartGame() {
            console.log('Restarting game...');
            hideGameCompleteContainer();
            resetGameState();
            showGameContainer();
            loadNextQuestion();
        }

        // UI Helper Functions with improved animations
        function showAuthContainer() {
            elements.authContainer.classList.remove('initial-hide');
            elements.authContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.authContainer, 
                    { opacity: 0, scale: 0.8, y: 50 }, 
                    { opacity: 1, scale: 1, y: 0, duration: 0.8, ease: "back.out(1.7)" }
                );
            } else {
                elements.authContainer.style.opacity = '1';
            }
        }

        function hideAuthContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.authContainer, {
                    opacity: 0,
                    scale: 0.8,
                    y: -50,
                    duration: 0.5,
                    ease: "back.in(1.7)",
                    onComplete: () => {
                        elements.authContainer.style.display = 'none';
                    }
                });
            } else {
                elements.authContainer.style.display = 'none';
            }
        }

        function hideSetupContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.setupContainer, {
                    opacity: 0,
                    scale: 0.8,
                    rotationY: 90,
                    duration: 0.5,
                    ease: "back.in(1.7)",
                    onComplete: () => {
                        elements.setupContainer.style.display = 'none';
                    }
                });
            } else {
                elements.setupContainer.style.display = 'none';
            }
        }

        function showGameContainer() {
            elements.gameContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.gameContainer, 
                    { opacity: 0, y: 100, scale: 0.9 }, 
                    { opacity: 1, y: 0, scale: 1, duration: 0.8, ease: "power3.out" }
                );
            }
        }

        function hideGameContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.gameContainer, {
                    opacity: 0,
                    scale: 0.9,
                    y: -50,
                    duration: 0.5,
                    onComplete: () => {
                        elements.gameContainer.style.display = 'none';
                    }
                });
            } else {
                elements.gameContainer.style.display = 'none';
            }
        }

        function showGameCompleteContainer() {
            elements.gameCompleteContainer.style.display = 'block';
            if (typeof gsap !== 'undefined') {
                gsap.fromTo(elements.gameCompleteContainer, 
                    { opacity: 0, scale: 0.8, rotationX: -90 }, 
                    { opacity: 1, scale: 1, rotationX: 0, duration: 1, ease: "back.out(1.7)" }
                );
                
                // Animate final score with delay
                gsap.fromTo('.final-score-display', 
                    { scale: 0, rotation: -180 },
                    { scale: 1, rotation: 0, duration: 0.8, delay: 0.5, ease: "back.out(2)" }
                );
            }
        }

        function hideGameCompleteContainer() {
            if (typeof gsap !== 'undefined') {
                gsap.to(elements.gameCompleteContainer, {
                    opacity: 0,
                    scale: 0.8,
                    duration: 0.5,
                    onComplete: () => {
                        elements.gameCompleteContainer.style.display = 'none';
                    }
                });
            } else {
                elements.gameCompleteContainer.style.display = 'none';
            }
        }

        function showLoading() {
            elements.loadingContainer.style.display = 'block';
            elements.questionContainer.style.display = 'none';
            
            if (typeof gsap !== 'undefined') {
                gsap.fromTo('.loading', 
                    { scale: 0, rotation: 0 },
                    { scale: 1, rotation: 360, duration: 0.5, ease: "back.out(1.7)" }
                );
            }
        }

        function hideLoading() {
            elements.loadingContainer.style.display = 'none';
            elements.questionContainer.style.display = 'block';
        }

        function showError(message, container = null) {
            console.log('Showing error:', message);
            if (container) {
                container.style.display = 'block';
                container.querySelector('.error-message').textContent = message;
                
                if (typeof gsap !== 'undefined') {
                    gsap.fromTo(container, 
                        { opacity: 0, scale: 0.9, y: 20 },
                        { opacity: 1, scale: 1, y: 0, duration: 0.5, ease: "back.out(1.7)" }
                    );
                }
            }
        }

        function hideError(container) {
            if (container) {
                if (typeof gsap !== 'undefined') {
                    gsap.to(container, {
                        opacity: 0,
                        scale: 0.9,
                        y: -20,
                        duration: 0.3,
                        onComplete: () => {
                            container.style.display = 'none';
                        }
                    });
                } else {
                    container.style.display = 'none';
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle page cleanup
        window.addEventListener('beforeunload', () => {
            clearInterval(gameState.timer);
            if (typeof gsap !== 'undefined') {
                gsap.killTweensOf("*");
            }
        });
    </script>
</body>
</html>
